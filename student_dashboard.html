<!DOCTYPE html>
<html>

<head>
  <title>Student Dashboard</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    .course {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    button {
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <h2>üéì Welcome, Student</h2>
  <p id="studentEmail"></p>

  <h3>All Courses:</h3>
  <div id="allCourses"></div>

  <h3>My Enrolled Courses:</h3>
  <ul id="enrolledList"></ul>

  <button onclick="logout()">Logout</button>

  <script>
    const studentEmail = localStorage.getItem("userEmail");
    const role = localStorage.getItem("userRole");
    if (role !== "student") {
      alert("Access denied. Redirecting to login.");
      window.location.href = "login.html";
    }

    document.getElementById("studentEmail").textContent = "Logged in as: " + studentEmail;

    const allCoursesDiv = document.getElementById("allCourses");
    const enrolledList = document.getElementById("enrolledList");

    const allCourses = JSON.parse(localStorage.getItem("courses") || "[]");
    const enrolled = JSON.parse(localStorage.getItem("enrolled_" + studentEmail) || "[]");

    function showCourses() {
      allCoursesDiv.innerHTML = "";
      allCourses.forEach((course, index) => {
        const courseDiv = document.createElement("div");
        courseDiv.className = "course";
        courseDiv.innerHTML = `
          <strong>${course.title}</strong><br>${course.description}<br>
          <em>Created by: ${course.createdBy}</em><br>
          <button onclick="enroll(${index})">Enroll</button>
          <button onclick="viewDetails(${index})">View Details</button>
        `;
        allCoursesDiv.appendChild(courseDiv);
      });
    }

    function showEnrolledCourses() {
      enrolledList.innerHTML = "";
      enrolled.forEach((course, index) => {
        const li = document.createElement("li");
        const status = course.completed ? "‚úÖ Completed" : "‚ùå Not Completed";
        li.innerHTML = `
        <strong>${course.title}</strong> - ${course.description} <br>
        Status: ${status}
        <button onclick="toggleComplete(${index})">${course.completed ? "Mark Incomplete" : "Mark Completed"}</button>
        ${course.completed ? `<button onclick="downloadCertificate('${course.title}')">üéì Download Certificate</button>` : ""}
      `;
        enrolledList.appendChild(li);
      });
    }

    function enroll(index) {
      const selected = allCourses[index];
      const alreadyEnrolled = enrolled.some(c => c.title === selected.title);
      if (alreadyEnrolled) {
        alert("Already enrolled!");
        return;
      }
      enrolled.push(selected);
      localStorage.setItem("enrolled_" + studentEmail, JSON.stringify(enrolled));
      showEnrolledCourses();
    }

    function unenroll(title) {
      const updatedEnrolled = enrolled.filter(course => course.title !== title);
      localStorage.setItem("enrolled_" + studentEmail, JSON.stringify(updatedEnrolled));
      enrolled.length = 0;
      updatedEnrolled.forEach(c => enrolled.push(c));
      showEnrolledCourses();
    }
    function viewDetails(index) {
      const selected = allCourses[index];
      localStorage.setItem("selectedCourse", JSON.stringify(selected));
      window.location.href = "course_details.html";
    }

    function toggleComplete(index) {
      enrolled[index].completed = !enrolled[index].completed;
      localStorage.setItem("enrolled_" + studentEmail, JSON.stringify(enrolled));
      showEnrolledCourses();
    }
    
    function downloadCertificate(courseTitle) {
      const studentName = studentEmail.split("@")[0]; // You can also ask for full name
      const date = new Date().toLocaleDateString();

      const certText = `
    CERTIFICATE OF COMPLETION

    This certifies that
    ${studentName}

    has successfully completed the course
    "${courseTitle}"

    Date: ${date}
  `;

      const blob = new Blob([certText], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${courseTitle}_Certificate.txt`;
      link.click();
    }


    function logout() {
      localStorage.removeItem("userEmail");
      localStorage.removeItem("userRole");
      window.location.href = "login.html";
    }

    showCourses();
    showEnrolledCourses();
  </script>
</body>

</html>